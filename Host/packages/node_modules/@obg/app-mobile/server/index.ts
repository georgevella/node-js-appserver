// general imports
import "@jorge/lib-webapphost";
import "@jorge/lib-di";
import "@jorge/app-diagnostics";
import "@jorge/lib-devicedetection";
import "@jorge/lib-marketdetection";

// development server specific imports
import * as wpconf from '../config/webpack.dev';
import * as webpack from 'webpack';
import * as WebpackDevServer from 'webpack-dev-server';


import { IServiceProvider, initializeDependencyInjection, getGlobalServiceProvider } from "@jorge/lib-di";
import { IWebApplicationHost, TWebApplicationHost } from "@jorge/lib-webapphost";

console.log("Initializing development server");

initializeDependencyInjection();

const serviceProvider: IServiceProvider = getGlobalServiceProvider();
const host: IWebApplicationHost = serviceProvider.getService(TWebApplicationHost);

host.initialize();

const serverOptions : WebpackDevServer.Configuration = {
    hot: true,
    inline: true,
    historyApiFallback: true,
    clientLogLevel: 'info',
    before: app => {
        host.extend(app);    
    },
    stats: {
        timings: true,
        colors: true,
        hash: true,
        version: true,
        assets: true,
        chunks: true,
        modules: true,
        warnings: true
    }
};

// setup hmr
const hmrEndpoints = [
    'webpack-dev-server/client?http://0.0.0.0:0',
    'webpack/hot/dev-server'
];

Object.keys(wpconf.default.entry).forEach(key => {
    if (key === 'main') {
        const entry = wpconf.default.entry[key];

        if (!Array.isArray(entry)) {
            wpconf.default.entry[key] = [...hmrEndpoints, entry];
        } else {
            wpconf.default.entry[key] = [...hmrEndpoints, ...entry];
        }
    }
});

wpconf.default.plugins.push(new webpack.HotModuleReplacementPlugin());

const compiler = webpack(wpconf.default);
const server = new WebpackDevServer(compiler, serverOptions);

console.log('Starting development host on port 3000');
server.listen(3000, (e: Error) => {
    console.log('Error: ' + e.message);
});

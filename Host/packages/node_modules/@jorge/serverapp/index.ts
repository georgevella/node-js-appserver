import { IContainer } from "container-ioc";
import * as express from "express";
import * as bp from "body-parser";
import * as cp from "cookie-parser";
import * as path from "path";
import * as logger from "morgan";
import "reflect-metadata";

import { debug } from "util";
import {
  IWebApplicationHost,
  WebApplicationHost,
  IExpressRouteProvider,
  TWebApplicationHost
} from "@jorge/lib-webapphost";

import "@jorge/lib-di";
import "@jorge/app-mobile";
import { IServiceProvider, initializeDependencyInjection, getGlobalServiceProvider } from "@jorge/lib-di";

class Server {
  serviceProvider: IServiceProvider;
  host: IWebApplicationHost;

  /**
   *
   */
  public constructor() {
    this.serviceProvider = getGlobalServiceProvider();

    this.host = this.serviceProvider.getService(TWebApplicationHost);

    this.host.baseDirectory = path.join(__dirname, "../");
    this.host.addRoute(new DefaultRoutes());
  }

  /**
   * start
   */
  public start(port: number) {
    this.host.initialize();
    this.host.start(port);
  }
}

class DefaultRoutes implements IExpressRouteProvider {
  router: express.Router;
  public readonly path: string = "/test";

  constructor() {
    this.router = express.Router();

    this.router.get("/", (req, res) => {
      let container: IServiceProvider = Reflect.getMetadata(
        "container",
        req
      );
      let value: string = container.getService(Symbol.for("Name"));
      res.render("index", { title: "Express [" + value + "]" });
    });
  }

  public getExpressRouter(): express.Router {
    return this.router;
  }
}

initializeDependencyInjection();

let server = new Server();
server.start(3000);

import { IMiddleware } from "@jorge/lib-webapp-core";
import * as e from "express";
import { Injectable, Inject } from "container-ioc";
import { IMarketDetectionService, IMarket } from "./interfaces";
import { TMarketDetectionService } from "./symbols";
import "reflect-metadata";

const MarketDetectionRequestMetadata: string = "marketinfo";

@Injectable()
export class MarketDetectionMiddleware implements IMiddleware {
  constructor(
    @Inject(TMarketDetectionService)
    private marketDetectionService: IMarketDetectionService
  ) {}

  handleRequest(request: e.Request, response: e.Response): boolean {
    var market = this.marketDetectionService.detectMarket(request);
    Reflect.defineMetadata(MarketDetectionRequestMetadata, market, request);

    return true;
  }
}

export function getMarketInformation(req: e.Request): IMarket {
  var marketInformation: IMarket = Reflect.getMetadata(
    MarketDetectionRequestMetadata,
    req
  );
  return marketInformation;
}

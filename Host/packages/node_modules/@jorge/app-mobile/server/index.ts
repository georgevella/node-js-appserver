import * as wpconf from '../config/webpack.dev';

import * as webpack from 'webpack';
import * as WebpackDevServer from 'webpack-dev-server';

const serverOptions = {
    hot: true,
    inline: true,
    historyApiFallback: true,
    clientLogLevel: 'info',
    stats: {
        timings: true,
        colors: true,
        hash: true,
        version: true,
        assets: true,
        chunks: true,
        modules: true,
        warnings: true
    }
};

// setup hmr
const hmrEndpoints = [
    'webpack-dev-server/client?http://0.0.0.0:0',
    'webpack/hot/dev-server'
];

const conf = wpconf.default as webpack.Configuration;

Object.keys(conf.entry).forEach(key => {
    if (key === 'main') {
        const entry = conf.entry[key];

        if (!Array.isArray(entry)) {
            conf.entry[key] = [...hmrEndpoints, entry];
        } else {
            conf.entry[key] = [...hmrEndpoints, ...entry];
        }
    }
});

conf.plugins.push(new webpack.HotModuleReplacementPlugin());

const compiler = webpack(conf);
const server = new WebpackDevServer(compiler, serverOptions);

console.log('Starting development host on port 3000');
server.listen(3000, (e: Error) => {
    console.log('Error: ' + e.message);
});

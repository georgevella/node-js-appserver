import { getCurrentContainer } from "@jorge/lib-di-express";
import { IServiceProvider } from "@jorge/lib-di";
import * as express from "express";

export interface IMiddleware {
  run(request: express.Request, response: express.Response): boolean;
}

export interface MiddlewareHandler {
  (
    req: express.Request,
    res: express.Response,
    next: express.NextFunction
  ): void;
}

export function middleware(token: Symbol): MiddlewareHandler {
  return (
    req: express.Request,
    res: express.Response,
    next: express.NextFunction
  ) => {
    var container: IServiceProvider = getCurrentContainer(req);
    var middleware: IMiddleware = container.getService<IMiddleware>(token);

    if (middleware.run(req, res)) {
      next();
    }
  };
}

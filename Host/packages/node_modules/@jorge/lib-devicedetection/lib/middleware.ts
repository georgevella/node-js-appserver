import {TDeviceDetection} from './symbols';
import {IDeviceInformation, IDeviceDetectionService} from './interfaces';
import * as express from 'express';
import { getCurrentContainer } from "@jorge/lib-di-express";

const DeviceDetectionRequestMetadata : string = "deviceinfo";

export function devicedetection(
  req: express.Request,
  res: express.Response,
  next: express.NextFunction
) {
  var uaString: string = req.header("user-agent") as string;
  if (uaString != undefined) {
    var serviceProvider = getCurrentContainer(req);
    var deviceDetectionService = serviceProvider.getService<IDeviceDetectionService>(TDeviceDetection);

    var result = deviceDetectionService.parseUserAgent(uaString);

    console.log("DeviceInformation: " + JSON.stringify(result));

    Reflect.defineMetadata(DeviceDetectionRequestMetadata, result, req);
  }

  next();
}

export function getDeviceInformation( req: express.Request ) : IDeviceInformation
{
    var deviceInformation: IDeviceInformation = Reflect.getMetadata(DeviceDetectionRequestMetadata, req);
    return deviceInformation;
}